// Function to update direction popup with the current step
function updatePopupStep(step) {
    document.getElementById('stepInfo').innerHTML = "Next Step";
    document.getElementById('nextDirection').innerHTML = step.text;
}

// Get the 'id' parameter from the URL
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(window.location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}

// Extract gravesite ID from the URL and center map on it
var gravesiteId = getUrlParameter('id');

if (gravesiteId) {
    var gravesite = gravesites.find(function(site) {
        return site.id == gravesiteId;
    });

    if (gravesite) {
        // Add marker for the gravesite
        var marker = L.marker([gravesite.lat, gravesite.lng], { icon: gravestoneIcon }).addTo(map);
        marker.bindPopup(gravesite.name).openPopup();

        // Guide to the gravesite
        guideToGravesite(gravesite.lat, gravesite.lng);
    }
}

// Device motion and orientation API for the arrow indicator
window.addEventListener('load', function() {
    var arrow = document.querySelector('.arrow');
    var userMarker = document.querySelector('.blinking-marker');

    function updateArrowPosition(event) {
        if (event.alpha !== null) {
            var rotation = event.alpha; // Use alpha value for rotation
            var radius = 30; // Distance from the center of the marker
            var angle = rotation * Math.PI / 180; // Convert to radians
            var offsetX = radius * Math.cos(angle);
            var offsetY = radius * Math.sin(angle);
            
            // Update the position of the arrow relative to the user marker
            arrow.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px)`;
        }
    }

    // Check for device orientation support
    if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', updateArrowPosition);
    } else {
        console.log('DeviceOrientationEvent is not supported.');
    }
});
